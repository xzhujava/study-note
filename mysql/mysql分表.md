## 分库分表

---

### 作用

- 解决由于 **数据量过大** 而导致数据库性能降低的问题
    - 碰到过的需求场景：一套租户数据一个库（物理隔离）
- 例如：
    - 微服务架构中，每个服务一个独立数据库（分库）
    - 一些业务日志表，按月拆成不同的表（分表）

### 方式

- 分库、分表，统称为数据分片
- 可以分为 **垂直分片** 和 **水平分片**

#### 垂直分片

- 核心理念：**专库专用**

![](https://note.youdao.com/yws/public/resource/df15b9a4c400815870b14a58c25dbb8f/A4F4BCF99FE14CFAA2369831CEBF3EE6?ynotemdtimestamp=1631241134004)

- 垂直分片通常需要对架构和设计进行调整，通常是来不及应对业务需求快速变化的
    - 可以缓解数据量和访问量带来的问题
    - 但无法真正解决单点数据库的性能瓶颈，单表数据量超过阈值，仍需进行水平分片

#### 水平分片

- 通过某些字段、某些规则，将数据分散到多个库或多个表中
    - 每个分片仅包含数据的一部分

![](https://note.youdao.com/yws/public/resource/df15b9a4c400815870b14a58c25dbb8f/6D10185AFA11449A926275338E4E2A31?ynotemdtimestamp=1631241134004)

##### 常用分片策略

- 取余/取模
    - 优点：均匀存放数据
    - 缺点：扩容非常麻烦（得把数据全部搞出来，重新取模分片）
- 按照范围分片
    - 优点：好扩容
    - 缺点：数据分布不均匀
- 按照时间分片
    - 容易将热点数据区分出来
- 按照枚举值分片
    - 例如：按地区分片
- 按照目标字段前缀指定进行分片
    - 自定义业务规则分片

##### 简单说明

- 水平分片，理论上突破了单机数量处理的瓶颈
    - 扩展相对自由，是分库分表的标准解决方案
- 一般在系统设计阶段，就应该根据业务耦合松紧，来确定垂直分库、垂直分表方案
    - 在数据量及访问压力不大时，首先考虑 缓存、读写分离、索引技术等方案
    - 若数据量极大，且持续增长，再考虑水平分库、水平分表方案

### 缺点

- 事务一致性问题
    - 分库分表后，数据分布在不同库甚至不同服务器，不可避免带来分布式事务问题
- 跨节点关联查询问题
    - 表被分散到不同库，无法进行关联查询
    - 此时需要将 关联查询 拆分成多次查询，然后将获得的结果进行拼装
- 跨节点分页、排序函数
    - 跨节点多库进行 limit分页、order by排序等查询时，需要现在不同的分片中将 数据进行排序并返回，然后将不同分片返回的结果集，进行汇总和再次排序
- 主键避重问题
    - 需要单独设计全局主键，以避免跨库主键重复问题
- 公共表处理
    - 像 参数表、字典表 等公共表，每个数据库都要保存一份
    - 并且对公共表的操作，都要分发到所有分库去执行
- 逻辑复杂度
    - 开发人员、运维人员，需要知道路由键及分片规则
    - 才能找到数据最终落到哪个位置

### 什么时候需要分库分表

- 阿里建议MySQL单表数据达到 500w 或 2G，就进行分库分表
- 业务需要做数据的物理隔离时
- 其实能不用就不用，用了问题多
    - 可以使用本身就支持分布式、数据分片的产品，如 Tidb、PgSQL、ES、....


### 常见的分库分表组件

#### Sharding Sphere

[Sharding Sphere](https://shardingsphere.apache.org/document/current/cn/overview/)

- Sharding-JDBC是当当网研发的开源分布式数据库中间件，他是一套开源的分布式数据库中间件解决方案组成的生态圈，它由Sharding-JDBC、Sharding-Proxy和Sharding-Sidecar（计划中）这3款相互独立的产品组成。 他们均提供标准化的数据分片、分布式事务和 数据库治理功能，可适用于如Java同构、异构语言、容器、云原生等各种多样化的应用场景。

#### MyCat

[MyCat](http://www.mycat.org.cn/)

- 基于阿里开源的Cobar产品而研发，Cobar的稳定性、可靠性、优秀的架构和性能以及众多成熟的使用案例使得MYCAT一开始就拥有一个很好的起点，站在巨人的肩膀上，我们能看到更远。业界优秀的开源项目和创新思路被广泛融入到MYCAT的基因中，使得MYCAT在很多方面都领先于目前其他一些同类的开源项目，甚至超越某些商业产品。

#### DBLE

[DBLE](https://opensource.actionsky.com/)

- 该网站包含几个重要产品。其中分布式中间件可以认为是MyCAT的一个增强版，专注于MySQL的集群化管理。另外还有数据传输组件和分布式事务框架组件可供选择。




